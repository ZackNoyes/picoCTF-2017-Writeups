# A Happy Union - 110 Points

I really need access to [website](http://shell2017.picoctf.com:23598/), but I forgot my password and there is no reset. Can you help? I like lite sql :)

**Hint:** A SQL union allows a single query to select values from multiples tables.

## Writeup

As both the problem description and hint imply, this is another SQL injection problem. However, this time it seems we will have to make use of SQL's `UNION` operator, which allows you to combine multiple `SELECT` statements into one query. Now that we know this, we must look for a place to perform our injection. After playing around with the website, three potential locations become obvious: the login form, the register form, and (once you've logged in) the post form. Some more fiddling rules out the post form, as it does not seem to respond to any kind of SQL statements, and the login form which appears to properly sanitize all input before checking if the submitted username/password combo exists in its database.

That leaves the register form. At first it may appear that SQL injections don't work here either because all it does is create an account rather than query the database. But in fact, this is exactly what we need. By creating an account with an SQL query as its username, we can now get SQL past the login form's account validation. Once we begin our attack, it will become more clear why this works.

The first thing I tried was simply using a `'` as the username (password can be anything you want, so I kept it easy and always used "1"). I figured this would screw up any SQL query and perhaps produce an error message that could be of use. I guessed correctly and the website very helpfully provided the query it was using: `select id, user, post from posts where user = ''';`. Now we know how the website selects the posts to display when you log in. After it validates your username and password, it finds every post in the `posts` table where the user column is equal to your username. Let's exploit this!

At the end of the problem description, it mentions liking "lite sql", suggesting that the website uses an sqlite database as opposed to mySQL or another SQL database. How does this help us? Well, the problem suggests that we need to recover the admin password ("I forgot my password...Can you help?") so we need to somehow convince the website to show us a list of users and their passwords. To do this we need to know the name of the table containing user accounts. SQLite by default has a table called `sqlite_master` that contains a list of every table's name and columns. This is where that `UNION` operator comes in. In order to view the `sqlite_master` we need to use the following injection: `' or 1=1 union select name,sql,3 from sqlite_master --`. Let's break down what this does.
* As before, we must use `' or 1=1` to bypass the username check. Alternatively, you could omit the `or 1=1` by using the username of an existing account, such as admin. (ex: `admin' union select name,sql,3 from sqlite_master --`)
* Now we use `union` to append our own query. Since the wesbite selects three columns from the `posts` table, we also want to select three columns (any other number throws an error) from the `sqlite_master` table. The columns `name` and `sql` provide the table names and columns (technically the SQL statement that created the table but this includes columns which is all we care about) of every table in the database. The last column (`3`) is just a "dummy" value to get us to three columns.
* `--` comments out the rest of the query.

After this injection, we learn that the database contains a `users` table with the columns `user` and `pass`. Finally, we can get the admin password (the flag!) using an injection similar to the previous one: `' or 1=1 union select user, pass, 3 from users --`. This shows us the flag and we're done!

## Helpful Resources

[https://www.w3schools.com/sql/sql_union.asp](https://www.w3schools.com/sql/sql_union.asp) 

[http://stackoverflow.com/questions/6460671/sqlite-schema-information-metadata](http://stackoverflow.com/questions/6460671/sqlite-schema-information-metadata)